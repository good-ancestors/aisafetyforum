generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Better Auth Models
// These are the core authentication models used by Better Auth
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

// ============================================================================
// Application Models
// ============================================================================

model SpeakerProposal {
  id            String   @id @default(cuid())
  email         String
  name          String
  organisation  String
  title         String
  bio           String?
  linkedin      String?
  twitter       String?
  bluesky       String?
  website       String?
  format        String
  abstract      String
  travelSupport String
  anythingElse  String?
  acceptedTerms Boolean  @default(true)
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  profileId     String?
  profile       Profile? @relation(fields: [profileId], references: [id])

  @@index([email])
  @@index([status])
  @@index([profileId])
}

model FundingApplication {
  id             String   @id @default(cuid())
  email          String
  name           String
  location       String
  organisation   String
  role           String
  whyAttend      String
  amount         String
  day1           Boolean  @default(true)
  day2           Boolean  @default(true)
  acceptedTerms  Boolean  @default(true)
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  profileId      String?
  backgroundInfo String[] @default([])
  bio            String?
  bluesky        String?
  linkedin       String?
  travelSupport  String?
  twitter        String?
  website        String?
  profile        Profile? @relation(fields: [profileId], references: [id])

  @@index([email])
  @@index([status])
  @@index([profileId])
}

model Registration {
  id              String        @id @default(cuid())
  email           String
  name            String
  organisation    String?
  ticketType      String
  ticketPrice     Int?
  stripeSessionId String?       @unique
  stripePaymentId String?
  amountPaid      Int
  originalAmount  Int
  discountAmount  Int           @default(0)
  couponId        String?
  status          String        @default("pending")
  attendeeDetails Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  profileId       String?
  orderId         String?
  coupon          DiscountCode? @relation(fields: [couponId], references: [id])
  order           Order?        @relation(fields: [orderId], references: [id])
  profile         Profile?      @relation(fields: [profileId], references: [id])

  @@index([email])
  @@index([status])
  @@index([stripeSessionId])
  @@index([couponId])
  @@index([profileId])
  @@index([orderId])
}

model DiscountCode {
  id              String            @id @default(cuid())
  code            String            @unique
  description     String
  type            String
  value           Int
  validFor        String[]
  allowedEmails   String[]
  maxUses         Int?
  currentUses     Int               @default(0)
  active          Boolean           @default(true)
  grantsAccess    Boolean           @default(false) // Allows registration in gated mode
  validFrom       DateTime?
  validUntil      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  orders          Order[]
  registrations   Registration[]
  waitlistSignups WaitlistSignup[]

  @@index([code])
  @@index([active])
}

model WaitlistSignup {
  id        String        @id @default(cuid())
  email     String        @unique
  status    String        @default("pending") // pending | notified | registered
  codeId    String?
  code      DiscountCode? @relation(fields: [codeId], references: [id])
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([email])
  @@index([status])
  @@index([codeId])
}

model FreeTicketEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String
  active    Boolean  @default(true)
  notified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([active])
}

// Central profile - one per person, linked by email and optionally auth user
model Profile {
  id                  String               @id @default(cuid())
  authUserId          String?              @unique // Links to User.id - set when user authenticates
  email               String               @unique
  name                String?
  title               String?
  organisation        String?
  gender              String?              // female, male, non-binary, other, or null (prefer not to say)
  dietaryRequirements String?              // Free text for dietary needs (vegetarian, vegan, allergies, etc.)
  avatarUrl           String?              // Custom avatar URL (from Uploadthing), overrides Gravatar
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  bio                 String?
  bluesky             String?
  isAdmin             Boolean              @default(false)
  linkedin            String?
  twitter             String?
  website             String?
  fundingApplications FundingApplication[]
  registrations       Registration[]
  speakerProposals    SpeakerProposal[]

  @@index([email])
  @@index([authUserId])
}

model Order {
  id              String         @id @default(cuid())
  purchaserEmail  String
  purchaserName   String
  paymentMethod   String         @default("card")
  paymentStatus   String         @default("pending")
  stripeSessionId String?        @unique
  stripePaymentId String?
  stripeInvoiceId String?        @unique
  totalAmount     Int
  discountAmount  Int            @default(0)
  orgName         String?
  orgABN          String?
  poNumber        String?
  couponId        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  invoiceDueDate  DateTime?
  invoiceNumber   String?        @unique
  coupon          DiscountCode?  @relation(fields: [couponId], references: [id])
  registrations   Registration[]

  @@index([purchaserEmail])
  @@index([paymentStatus])
  @@index([stripeSessionId])
  @@index([stripeInvoiceId])
  @@index([invoiceNumber])
}
